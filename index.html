<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Sound Box</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #1a1a2e;
            color: white;
            overflow-x: hidden;
        }

        .pacman {
            width: 0px;
            height: 0px;
            border-right: 12px solid transparent;
            border-top: 12px solid #ef4444; /* red-500 */
            border-left: 12px solid #ef4444;
            border-bottom: 12px solid #ef4444;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            position: relative;
            animation: eat 0.4s infinite linear alternate;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.8);
            z-index: 50;
        }
        
        @keyframes eat {
            0% { clip-path: polygon(100% 74%, 44% 48%, 100% 21%, 100% 0, 0 0, 0 100%, 100% 100%); }
            100% { clip-path: polygon(100% 60%, 44% 48%, 100% 40%, 100% 0, 0 0, 0 100%, 100% 100%); }
        }

        .heart-token {
            filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.8));
            animation: beat 1.5s infinite;
        }

        @keyframes beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* URGENT FLASH ANIMATION */
        .urgent-mode {
            animation: flash-bg 0.33s infinite;
        }

        @keyframes flash-bg {
            0%, 100% { background-color: #dc2626; color: white; }
            50% { background-color: white; color: #dc2626; }
        }

        .urgent-mode .progress-bar-fill {
            animation: flash-bar 0.33s infinite;
        }

        @keyframes flash-bar {
            0%, 100% { background-color: white; }
            50% { background-color: #dc2626; }
        }

        .modal-overlay {
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }

        /* Custom scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- AUDIO ENGINE (Simple Web Audio API) ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            const now = ctx.currentTime;

            if (type === 'tick') {
                // High pitch beep
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'end') {
                // Buzzer
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.5);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'success') {
                // Happy chord
                [440, 554, 659].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g);
                    g.connect(ctx.destination);
                    o.type = 'triangle';
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.05, now + i*0.05);
                    g.gain.exponentialRampToValueAtTime(0.001, now + 0.5 + i*0.05);
                    o.start(now + i*0.05);
                    o.stop(now + 0.6);
                });
            } else if (type === 'fail') {
                // Sad slide
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.4);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            }
        };

        // --- DADES DEL JOC ---
        const WORD_DATABASE = [
            { text: "Esgotat", isKid: true }, { text: "Apicultor", isKid: true }, { text: "Rentar-se les dents", isKid: true }, 
            { text: "Combat de Superherois", isKid: true }, { text: "Zoològic", isKid: true }, { text: "Nit Freda", isKid: true },
            { text: "Joguines", isKid: true }, { text: "Dutxa", isKid: true }, { text: "Piscina", isKid: true }, 
            { text: "Clavegueram", isKid: true }, { text: "Grup musical dolent", isKid: true }, { text: "Oficina", isKid: true }, 
            { text: "Tecnologia Alienígena", isKid: true }, { text: "Arribar tard a la feina", isKid: false }, { text: "Òpera", isKid: true }, 
            { text: "Fuster", isKid: true }, { text: "Batalla de Rapers", isKid: true }, { text: "Perseguit per un assassí", isKid: false }, 
            { text: "Tarda d'estiu", isKid: true }, { text: "Tenir la Grip", isKid: true }, { text: "Ninja", isKid: true }, 
            { text: "Estable", isKid: true }, { text: "Ping Pong", isKid: true }, { text: "Cafeteria", isKid: true }, 
            { text: "Geni de la làmpada", isKid: true }, { text: "Beure aigua", isKid: true }, { text: "Partit de Futbol", isKid: true }, 
            { text: "Llançaflames", isKid: false }, { text: "Allau", isKid: true }, { text: "Accident de cotxe", isKid: false }, 
            { text: "Restaurant", isKid: true }, { text: "Focs Artificials", isKid: true }, { text: "Estrena de Hollywood", isKid: true },
            { text: "Cor trencat", isKid: false }, { text: "Comiat de soltera", isKid: false }, { text: "Puenting", isKid: true }, 
            { text: "Cursa de Cotxes", isKid: true }, { text: "Cantina de l'Oest", isKid: true }, { text: "Llenyataire", isKid: true }, 
            { text: "Motocicleta", isKid: true }, { text: "Vent", isKid: true }, { text: "DJ fent Scratch", isKid: true }, 
            { text: "Casa Encantada", isKid: true }, { text: "Cuina", isKid: true }, { text: "Rentavaixelles", isKid: true }, 
            { text: "Monòleg de Comèdia", isKid: false }, { text: "Infern", isKid: false }, { text: "Teletreball", isKid: false }, 
            { text: "Fàbrica", isKid: true }, { text: "Ciutat Futurista", isKid: true }, { text: "Escola Bressol", isKid: true }, 
            { text: "Fumar", isKid: false }, { text: "Xiuxiuejar", isKid: true }, { text: "Embús de trànsit", isKid: true }, 
            { text: "Cascades", isKid: true }, { text: "Càmping", isKid: true }, { text: "Biblioteca", isKid: true }, 
            { text: "Torneig Medieval", isKid: true }, { text: "Videojoc", isKid: true }, { text: "Camió del Butà", isKid: true }, 
            { text: "Granja", isKid: true }, { text: "Dentista", isKid: true }, { text: "Inodor", isKid: true }, 
            { text: "Obrir ampolla de vi", isKid: false }, { text: "Disc ratllat", isKid: true }, { text: "Zàping TV", isKid: true }, 
            { text: "Casino", isKid: false }, { text: "Cangur", isKid: true }, { text: "Metro", isKid: true }, 
            { text: "Bomba", isKid: false }, { text: "Trobada Alienígena", isKid: true }, { text: "Canó", isKid: true }, 
            { text: "Quart de bany", isKid: true }, { text: "Batalla Espacial", isKid: true }, { text: "Esmorzar", isKid: true }, 
            { text: "Aixeta que goteja", isKid: true }, { text: "Camió", isKid: true }, { text: "Abordatge Pirata", isKid: true }, 
            { text: "Parc de Dinosaures", isKid: true }, { text: "Caminar sobre fulles", isKid: true }, { text: "Ambulància", isKid: true }, 
            { text: "Avió estavellant-se", isKid: false }, { text: "Cel / Paradís", isKid: false }, { text: "Alienígena Malvat", isKid: true },
            { text: "Pistola amb silenciador", isKid: false }, { text: "Ioga", isKid: true }, { text: "Apocalipsi Zombi", isKid: true }, 
            { text: "Baralla de borratxos", isKid: false }, { text: "Sortir de copes", isKid: false }, { text: "Atracament a un banc", isKid: false }, 
            { text: "Olla de Bruixa", isKid: true }, { text: "Selva", isKid: true }, { text: "Arts Marcials", isKid: true }, 
            { text: "Castell", isKid: true }, { text: "Tennis", isKid: true }, { text: "Bussejar", isKid: true }, 
            { text: "Església", isKid: true }, { text: "Tocar la bateria", isKid: true }, { text: "Guitarrista virtuós", isKid: true }, 
            { text: "Ferrer", isKid: true }, { text: "Boxa", isKid: true }, { text: "Netejar vidres", isKid: true }, 
            { text: "Perdut al desert", isKid: true }, { text: "Lluna de mel", isKid: false }, { text: "Química", isKid: true }, 
            { text: "Detective", isKid: true }, { text: "Màgia", isKid: true }, { text: "Frontó", isKid: true }, 
            { text: "Guerra de boles de neu", isKid: true }, { text: "Espadatxí", isKid: true }, { text: "Helicòpter", isKid: true }, 
            { text: "Lluita Lliure", isKid: true }, { text: "Processó", isKid: true }, { text: "Bitlles", isKid: true }, 
            { text: "Indigestió", isKid: true }, { text: "Pistola d'aigua", isKid: true }, { text: "Obres", isKid: true }, 
            { text: "Salt de Trampolí", isKid: true }, { text: "Jacuzzi", isKid: true }, { text: "Rodeo", isKid: true }, 
            { text: "Viatge en el temps", isKid: true }, { text: "Concert Heavy Metal", isKid: true }, { text: "Foguera", isKid: true }, 
            { text: "Perruqueria", isKid: true }, { text: "Pissarra", isKid: true }, { text: "Veler", isKid: true }, 
            { text: "Astronauta", isKid: true }, { text: "Erupció Volcànica", isKid: true }, { text: "Superpoder", isKid: true }, 
            { text: "Barbacoa", isKid: true }, { text: "Aeroport", isKid: true }, { text: "Parc d'Atraccions", isKid: true }, 
            { text: "Submarí", isKid: true }, { text: "Aspiradora", isKid: true }, { text: "Serradora", isKid: true }, 
            { text: "Rebobinar", isKid: true }, { text: "Caça de combat", isKid: false }, { text: "Teletransportació", isKid: true }, 
            { text: "Flamenco", isKid: true }, { text: "Ascensor", isKid: true }, { text: "Encantador de serps", isKid: true }, 
            { text: "Màquina d'escriure", isKid: true }, { text: "Comiat de solter", isKid: false }, { text: "Escalar muntanya", isKid: true }, 
            { text: "Tempesta", isKid: true }, { text: "Vaquero", isKid: true }, { text: "Bosc", isKid: true }, 
            { text: "Bruixot", isKid: true }, { text: "Estany", isKid: true }, { text: "Porta", isKid: true }, 
            { text: "Bàsquet", isKid: true }, { text: "Cavernícola", isKid: true }, { text: "Paleta", isKid: true }, 
            { text: "Impressora", isKid: true }, { text: "Hospital", isKid: true }, { text: "Hacker", isKid: true }, 
            { text: "Bestiola a l'espatlla", isKid: true }, { text: "Trepitjada", isKid: true }, { text: "Cotxe vell", isKid: true }, 
            { text: "Barri perillós", isKid: false }, { text: "Tsunami", isKid: true }, { text: "Exèrcit", isKid: false }, 
            { text: "Billar", isKid: true }, { text: "Escola", isKid: true }, { text: "Gronxadors", isKid: true }, 
            { text: "Caure a terra", isKid: true }, { text: "Pas a nivell", isKid: true }, { text: "Gimnàs", isKid: true }, 
            { text: "Tir amb arc", isKid: true }, { text: "Excavar tresor", isKid: true }, { text: "Terratrèmol", isKid: true }, 
            { text: "Manifestació", isKid: false }, { text: "Ment maligna", isKid: true }, { text: "Discoteca", isKid: true }, 
            { text: "Port", isKid: true }, { text: "Guerra", isKid: false }, { text: "Ferri", isKid: true }, 
            { text: "Assassinat", isKid: false }, { text: "Pescador", isKid: true }, { text: "Comissaria", isKid: true }, 
            { text: "Anar a dormir", isKid: true }, { text: "Monstre Gegant", isKid: true }, { text: "Cap d'Any", isKid: true }, 
            { text: "Metròpolis", isKid: true }, { text: "Bomber", isKid: true }, { text: "Fotògraf", isKid: true }, 
            { text: "Batecs del cor", isKid: true }, { text: "Assalt al tren", isKid: false }, { text: "Sortir a córrer", isKid: true }, 
            { text: "Recreativa Arcade", isKid: true }, { text: "Caçador", isKid: false }, { text: "Metralleta", isKid: false }, 
            { text: "Despertar-se", isKid: true }, { text: "Cova", isKid: true }, { text: "Vòlei Platja", isKid: true }, 
            { text: "Jutjat", isKid: false }, { text: "Parc Aquàtic", isKid: true }, { text: "Netejar", isKid: true }, 
            { text: "Safari", isKid: true }, { text: "Relaxar-se", isKid: true }, { text: "Espasa Làser", isKid: true }, 
            { text: "Robot", isKid: true }, { text: "Ràdio", isKid: true }, { text: "Muntanya Russa", isKid: true }, 
            { text: "Platja", isKid: true }, { text: "Fregidora", isKid: true }, { text: "Cau de lladres", isKid: false }, 
            { text: "Romanç", isKid: false }, { text: "Drac", isKid: true }, { text: "Trepant", isKid: true }, 
            { text: "Fuga de la presó", isKid: false }, { text: "Teatre", isKid: true }, { text: "Acomiadat de la feina", isKid: false }, 
            { text: "Elefant", isKid: true }, { text: "Patinatge", isKid: true }, { text: "Avi en una mecedora", isKid: true }
        ];

        // --- COMPONENTS ---
        const Icons = {
            Heart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500 fill-current"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            BrokenHeart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500 fill-current"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="m12 13-2-2 3-3" stroke="black" strokeWidth="3" strokeLinecap="round" /></svg>,
            Crown: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm0 0 20 0"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><polyline points="20 6 9 17 4 12"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" className="text-red-500"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Double: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-400"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8"/><path d="M9 12H4l.6-2.9A8 8 0 0 1 20 12h-5"/><path d="m21 12-1 9-2.3 2.3-1.4-8.8"/></svg>,
            DoubleCrossed: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500/50"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8"/><path d="M9 12H4l.6-2.9A8 8 0 0 1 20 12h-5"/><path d="m21 12-1 9-2.3 2.3-1.4-8.8"/><line x1="2" y1="2" x2="22" y2="22" stroke="red" strokeWidth="3" opacity="0.7"/></svg>,
            Star: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" className="text-yellow-400"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></svg>,
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-400"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-white"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Help: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-300"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>,
            Move: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-orange-400"><path d="M13.5 4.5 11 2 8.5 4.5"/><path d="m6.3 16.5-2.7.6 6.5-6.5L11.5 9l-6.5 6.5.6 2.7Z"/><path d="M21 11.5 12 20.5l-3.5-3.5"/></svg>
        };

        // Configuració del track (13 espais: 11-20 + specials)
        const TRACK_LAYOUT = [
            { type: 'number', val: 11 },
            { type: 'number', val: 12 },
            { type: 'number', val: 13 },
            { type: 'double', val: null }, 
            { type: 'number', val: 14 },
            { type: 'number', val: 15 },
            { type: 'double', val: null }, 
            { type: 'number', val: 16 },
            { type: 'number', val: 17 },
            { type: 'number', val: 18 },
            { type: 'number', val: 19 },
            { type: 'number', val: 20 },
            { type: 'crown', val: null }
        ];

        const LIFE_TRACK_MAX = 14;

        // Variants boges del manual
        const CRAZY_VARIANTS = [
            { id: 'none', label: 'Normal', desc: 'Sense regles extra' },
            { id: 'who_speaks', label: 'Qui Parla?', desc: 'Els sorollosos s\'han d\'aturar 2 cops per dir el seu nom.' },
            { id: 'intermittent', label: 'Sons Intermitents', desc: "L'escoltador s'ha de tapar i destapar les orelles rítmicament." },
            { id: 'motion', label: 'Moviment (House Rule)', desc: 'Els sorollosos han de fer el so mentre es mouen.' }
        ];

        function App() {
            // --- ESTATS DEL JOC ---
            const [phase, setPhase] = useState('setup_count'); 
            const [playerCount, setPlayerCount] = useState(4);
            const [players, setPlayers] = useState([]); 
            const [currentListenerIndex, setCurrentListenerIndex] = useState(0);
            
            // Mode Nens, Enregistrador i Variants
            const [kidMode, setKidMode] = useState(false);
            const [hasRecorder, setHasRecorder] = useState(false);
            const [selectedVariant, setSelectedVariant] = useState('none');
            const [showRules, setShowRules] = useState(false);

            // Progrés
            const [score, setScore] = useState(0); 
            const [life, setLife] = useState(LIFE_TRACK_MAX); // Comença a 14
            
            // Dades de la ronda
            const [roundCards, setRoundCards] = useState(Array(20).fill(null)); 
            const [assignments, setAssignments] = useState({}); 
            const [revealedCards, setRevealedCards] = useState([]); 
            const [incorrectGuess, setIncorrectGuess] = useState(null); 
            
            // Fitxes dobles
            const [doubleTokenAssignedTo, setDoubleTokenAssignedTo] = useState([]); 
            const [currentDoubleAssignStep, setCurrentDoubleAssignStep] = useState(0); 

            // Inputs
            const [nameInputs, setNameInputs] = useState({});

            // Temporitzador
            const [timeLeft, setTimeLeft] = useState(13);
            const [timerActive, setTimerActive] = useState(false);

            // --- LÒGICA ---

            const getPenalty = (cardIndex) => {
                const num = cardIndex + 1; 
                if (num >= 14 && num <= 17) return 3;
                if ((num >= 10 && num <= 13) || num === 18) return 2;
                return 1;
            };

            const getUnlockedCount = (currentScore) => {
                let maxUnlocked = 10; 
                for(let i = 0; i < currentScore && i < TRACK_LAYOUT.length; i++) {
                    const cell = TRACK_LAYOUT[i];
                    if (cell.type === 'number') maxUnlocked = Math.max(maxUnlocked, cell.val);
                }
                return maxUnlocked;
            };

            const getAvailableDoublesCount = (currentScore, currentLife) => {
                let available = 0;
                if (currentScore > 3 && currentLife > 9) available++;
                if (currentScore > 6 && currentLife > 6) available++;
                return available;
            };

            const getFilteredDB = () => kidMode ? WORD_DATABASE.filter(c => c.isKid) : WORD_DATABASE;

            const getRandomNewCards = (amount, excludeList = []) => {
                const db = getFilteredDB();
                const available = db.filter(item => !excludeList.some(ex => ex && ex.text === item.text));
                const shuffled = [...available].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, amount);
            };

            const handlePlayerCountSelect = (count) => {
                setPlayerCount(count);
                const initialNames = {};
                for(let i=0; i<count; i++) initialNames[i] = `Jugador ${i+1}`;
                setNameInputs(initialNames);
                setHasRecorder(false);
                setPhase('setup_names');
            };

            const startGame = () => {
                const finalNames = [];
                for(let i=0; i<playerCount; i++) finalNames.push(nameInputs[i] || `Jugador ${i+1}`);
                setPlayers(finalNames);
                setScore(0); 
                setLife(LIFE_TRACK_MAX); 
                
                const randomStart = Math.floor(Math.random() * playerCount);
                setCurrentListenerIndex(randomStart);
                
                startRound(randomStart, true); 
            };

            const nextRound = () => {
                if (score >= TRACK_LAYOUT.length || life <= 0) { 
                    setPhase('gameover');
                    return;
                }
                const nextListener = (currentListenerIndex + 1) % playerCount;
                setCurrentListenerIndex(nextListener);
                startRound(nextListener, false);
            };

            const startRound = (targetListenerIndex, isFirstGame) => {
                const activeListener = targetListenerIndex !== undefined ? targetListenerIndex : currentListenerIndex;
                const unlockedCount = getUnlockedCount(score);

                let newCardsState = [...roundCards];

                if (isFirstGame) {
                    const newOnes = getRandomNewCards(10);
                    for(let i=0; i<10; i++) newCardsState[i] = newOnes[i];
                } else {
                    revealedCards.forEach(idx => { newCardsState[idx] = null; });
                    const holes = [];
                    for(let i=0; i<unlockedCount; i++) { if (newCardsState[i] === null) holes.push(i); }
                    const currentOnBoard = newCardsState.filter(c => c !== null);
                    const replacements = getRandomNewCards(holes.length, currentOnBoard);
                    holes.forEach((slotIdx, i) => { newCardsState[slotIdx] = replacements[i]; });
                }

                setRoundCards(newCardsState);
                setRevealedCards([]);
                setIncorrectGuess(null);
                setDoubleTokenAssignedTo([]);
                setCurrentDoubleAssignStep(0);

                const doublesAvailable = getAvailableDoublesCount(score, life);

                if (doublesAvailable > 0) {
                    setPhase('assign_double');
                } else {
                    generateAssignments(activeListener, [], unlockedCount);
                }
            };

            const getRecorderIndex = (listenerIdx) => {
                if (!hasRecorder || playerCount < 6) return -1;
                return (listenerIdx + 2) % playerCount;
            };

            const generateAssignments = (listenerIdx, doubleAssignees, unlockedCount) => {
                const newAssignments = {}; 
                const availableIndices = Array.from({length: unlockedCount}, (_, i) => i);
                const shuffledIndices = availableIndices.sort(() => 0.5 - Math.random());
                
                const recorderIdx = getRecorderIndex(listenerIdx);
                let tokenPointer = 0;
                
                for (let i = 0; i < playerCount; i++) {
                    if (i !== listenerIdx && i !== recorderIdx) {
                        let extraCards = 0;
                        doubleAssignees.forEach(dIdx => { if (dIdx === i) extraCards++; });
                        const count = 1 + extraCards;
                        const myCards = [];
                        for(let c=0; c<count; c++) {
                            if (tokenPointer < shuffledIndices.length) {
                                myCards.push(shuffledIndices[tokenPointer]);
                                tokenPointer++;
                            }
                        }
                        if (myCards.length > 0) newAssignments[i] = myCards; 
                    }
                }
                setAssignments(newAssignments);
                setPhase('roles');
            };

            const handleDoubleAssignment = (playerIdx) => {
                const newDoubleAssignees = [...doubleTokenAssignedTo, playerIdx];
                setDoubleTokenAssignedTo(newDoubleAssignees);
                const totalDoublesAvailable = getAvailableDoublesCount(score, life);
                if (newDoubleAssignees.length < totalDoublesAvailable) {
                    setCurrentDoubleAssignStep(currentDoubleAssignStep + 1);
                } else {
                    const unlockedCount = getUnlockedCount(score);
                    generateAssignments(currentListenerIndex, newDoubleAssignees, unlockedCount);
                }
            };

            const handleTimerFinish = () => {
                playSound('end');
                setTimerActive(false);
                setPhase('guess');
            };

            useEffect(() => {
                let interval = null;
                if (timerActive && timeLeft > 0) {
                    if(timeLeft <= 3) playSound('tick');
                    interval = setInterval(() => {
                        setTimeLeft((prev) => prev - 1);
                    }, 1000);
                } else if (timeLeft === 0 && timerActive) {
                    handleTimerFinish();
                }
                return () => clearInterval(interval);
            }, [timerActive, timeLeft]);

            const handleCardGuess = (cardIndex) => {
                if (revealedCards.includes(cardIndex) || incorrectGuess !== null) return;

                let found = false;
                Object.keys(assignments).forEach(pid => {
                    const cards = assignments[pid];
                    if (cards.includes(cardIndex)) found = true;
                });

                if (found) {
                    playSound('success');
                    const newRevealed = [...revealedCards, cardIndex];
                    setRevealedCards(newRevealed);
                    let totalAssignedCards = 0;
                    Object.values(assignments).forEach(arr => totalAssignedCards += arr.length);
                    if (newRevealed.length === totalAssignedCards) {
                        setTimeout(() => endRound(true, newRevealed.length), 1000);
                    }
                } else {
                    playSound('fail');
                    setIncorrectGuess(cardIndex);
                    setTimeout(() => endRound(false, revealedCards.length), 2000);
                }
            };

            const endRound = (perfect, currentHits) => {
                setPhase('results');
                let totalPenalty = 0;
                Object.values(assignments).forEach(cardArray => {
                    cardArray.forEach(cardIdx => {
                        if (!revealedCards.includes(cardIdx)) totalPenalty += getPenalty(cardIdx);
                    });
                });
                if (perfect) totalPenalty = 0;
                const newScore = Math.min(TRACK_LAYOUT.length, score + currentHits);
                const newLife = Math.max(0, life - totalPenalty);
                setScore(newScore);
                setLife(newLife);
            };

            // --- VISTES ---
            
            const renderTrack = () => (
                <div className="w-full max-w-5xl mx-auto mt-4 px-2 mb-2">
                    <div className="relative h-14 bg-gray-800 rounded-lg flex items-center px-2 shadow-inner border border-white/10 overflow-hidden">
                        <div className="flex w-full justify-between items-center z-0 px-1">
                            {TRACK_LAYOUT.map((item, idx) => (
                                <div key={idx} className="flex flex-col items-center justify-center w-6 md:w-8 h-full relative">
                                    <div className={`text-[10px] md:text-xs font-bold mb-1 ${idx+1 <= score ? 'text-white' : 'text-gray-600'}`}>
                                        {item.type === 'number' && item.val}
                                        {item.type === 'double' && <Icons.Double size={14} />}
                                        {item.type === 'crown' && <Icons.Crown size={14} />}
                                    </div>
                                    <div className={`w-1 h-1 rounded-full ${idx+1 <= score ? 'bg-blue-400' : 'bg-gray-700'}`}></div>
                                </div>
                            ))}
                        </div>
                        <div className="h-1 bg-blue-500/50 absolute bottom-4 left-0 transition-all duration-500 z-0" style={{ width: `calc(${(score / TRACK_LAYOUT.length) * 100}%)` }}></div>
                        <div className="absolute top-1/2 transform -translate-y-1/2 transition-all duration-500 z-10" style={{ left: score === 0 ? '-20px' : `calc(${((score - 0.5) / TRACK_LAYOUT.length) * 100}%)` }}>
                            <div className="pacman"></div>
                        </div>
                    </div>
                </div>
            );

            const renderLifeTrack = () => {
                const lifeSteps = Array.from({length: LIFE_TRACK_MAX + 1}, (_, i) => LIFE_TRACK_MAX - i);
                return (
                    <div className="w-full max-w-5xl mx-auto px-2 mb-4">
                        <div className="relative h-12 bg-red-900/30 rounded-lg flex items-center px-2 shadow-inner border border-red-500/20 overflow-hidden">
                            <div className="flex w-full justify-between items-center z-0 px-1">
                                {lifeSteps.map((val, idx) => (
                                    <div key={val} className="flex flex-col items-center justify-center w-6 md:w-8 h-full relative">
                                        {(val === 9 || val === 6) && <div className="absolute top-1 opacity-50"><Icons.DoubleCrossed /></div>}
                                        <div className={`text-[10px] md:text-xs font-bold ${val === 0 ? 'text-red-500' : 'text-gray-400'} ${val <= life ? 'opacity-100' : 'opacity-30'}`}>{val}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="absolute top-1/2 transform -translate-y-1/2 transition-all duration-500 z-10" style={{ left: `calc(${((14 - life) / 14) * 100}% - 10px)` }}>
                                <div className="heart-token text-red-500"><Icons.Heart size={24} className="fill-current"/></div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderBoard = (mode = 'view', overlayAssignments = false) => {
                const unlockedCount = getUnlockedCount(score);
                return (
                    <div className="grid grid-cols-4 md:grid-cols-5 gap-2 md:gap-3 max-w-5xl mx-auto p-2">
                        {roundCards.map((cardObj, idx) => {
                            const isLocked = idx >= unlockedCount;
                            const isRevealed = revealedCards.includes(idx);
                            const isIncorrect = incorrectGuess === idx;
                            const penalty = getPenalty(idx);
                            let assignedPlayerNames = [];
                            if (overlayAssignments && assignments) {
                                Object.entries(assignments).forEach(([pid, cardIndices]) => {
                                    if (cardIndices.includes(idx)) assignedPlayerNames.push(players[pid]);
                                });
                            }
                            const content = cardObj ? cardObj.text : (isLocked ? "" : "Buit");
                            return (
                                <div key={idx} onClick={() => mode === 'guess' && !isLocked && !isRevealed && handleCardGuess(idx)} className={`relative rounded-xl min-h-[80px] md:min-h-[100px] flex flex-col items-center justify-center text-center text-xs md:text-sm font-bold shadow-lg transition-all border-2 overflow-hidden ${isLocked ? 'bg-gray-800 border-gray-700 opacity-50 locked-slot text-transparent' : isRevealed ? 'bg-green-500 text-white border-green-400 scale-95' : isIncorrect ? 'bg-red-500 text-white border-red-400 shake' : 'bg-white text-gray-900 border-gray-300'} ${mode === 'guess' && !isLocked && !isRevealed ? 'cursor-pointer hover:bg-blue-50 hover:border-blue-400 hover:scale-105 z-10' : ''}`}>
                                    <div className="absolute top-1 left-2 z-10 opacity-70">{!isLocked && cardObj?.isKid && <div className="scale-75"><Icons.Star /></div>}</div>
                                    <div className="px-2 pt-6 pb-4 z-0 relative leading-tight">{!isLocked && content}</div>
                                    {!isLocked && <div className="absolute bottom-1 left-1 flex gap-0.5 z-10 opacity-70">{Array.from({length: penalty}).map((_, i) => <div key={i} className="transform scale-75"><Icons.BrokenHeart /></div>)}</div>}
                                    {assignedPlayerNames.length > 0 && <div className="absolute top-0 left-0 w-full h-[25%] bg-black/90 flex items-center justify-center z-20 shadow-md border-b border-white/20"><span className="text-yellow-400 font-bold text-[10px] md:text-xs truncate px-1 uppercase tracking-wider">{assignedPlayerNames.join(', ')}</span></div>}
                                    {isRevealed && <div className="absolute top-1 right-1 z-10"><Icons.Check size={16}/></div>}
                                    {isIncorrect && <div className="absolute top-1 right-1 z-10"><Icons.X size={16}/></div>}
                                </div>
                            );
                        })}
                    </div>
                );
            };

            const RulesModal = () => (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={() => setShowRules(false)}>
                    <div className="bg-gray-900 border border-white/20 p-6 rounded-2xl max-w-lg w-full max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-bold">Regles Ràpides</h3>
                            <button onClick={() => setShowRules(false)}><Icons.X/></button>
                        </div>
                        <div className="space-y-4 text-sm opacity-90">
                            <p><strong>Objectiu:</strong> Arribar a la corona (final del track) abans que la vida (cors) arribi a 0.</p>
                            <p><strong>Rols:</strong> 1 Escoltador (endevina), la resta són Sorollosos (fan soroll). Si sou 6+, pot haver-hi 1 Enregistrador (ajuda a recordar).</p>
                            <div><strong>Joc:</strong>
                                <ul className="list-disc ml-5 mt-1">
                                    <li>Es reparteixen cartes als Sorollosos.</li>
                                    <li>L'Escoltador es tapa els ulls.</li>
                                    <li>Tothom fa el seu soroll durant 13s.</li>
                                    <li>L'Escoltador destapa les cartes que creu haver sentit.</li>
                                </ul>
                            </div>
                            <p><strong>Puntuació:</strong> +1 punt per encert (mou Pacman). Si falles, perds vida segons la posició de la carta (-1, -2 o -3 cors).</p>
                            <p><strong>Fitxes Dobles:</strong> Es desbloquegen a l'avançar. Permeten que un jugador faci 2 sons. Si la vida baixa de 9 o 6, es perden.</p>
                        </div>
                    </div>
                </div>
            );

            // --- RENDER PHASES ---

            if (phase === 'setup_count') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-indigo-900 to-black text-center">
                        <div className="absolute top-4 right-4"><button onClick={() => setShowRules(true)} className="p-2 rounded-full bg-white/10 hover:bg-white/20"><Icons.Help /></button></div>
                        {showRules && <RulesModal />}
                        <h1 className="text-6xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-pink-500" style={{fontFamily: 'Fredoka'}}>Digital Sound Box</h1>
                        <p className="text-xl mb-8 text-blue-200">Edició Digital en Català</p>
                        <div className="bg-white/10 p-8 rounded-2xl backdrop-blur-md w-full max-w-md border border-white/20 shadow-xl">
                            <label className="block text-lg mb-4 font-bold">Quants jugadors sou?</label>
                            <div className="flex justify-center gap-4 mb-6">
                                {[4, 5, 6, 7].map(num => <button key={num} onClick={() => handlePlayerCountSelect(num)} className={`w-12 h-12 rounded-full font-bold text-xl transition-all ${playerCount === num ? 'bg-pink-500 scale-110 shadow-lg shadow-pink-500/50' : 'bg-indigo-700 hover:bg-indigo-600'}`}>{num}</button>)}
                            </div>
                            <div onClick={() => setKidMode(!kidMode)} className={`cursor-pointer flex items-center justify-center gap-3 p-3 rounded-lg border transition-all ${kidMode ? 'bg-green-500/20 border-green-500' : 'bg-white/5 border-white/10'}`}>
                                <div className={`w-6 h-6 rounded flex items-center justify-center border ${kidMode ? 'bg-green-500 border-green-500' : 'border-gray-400'}`}>{kidMode && <Icons.Check size={16} className="text-white" />}</div>
                                <span className="font-bold text-sm">Mode Nens (Paraules fàcils)</span>
                            </div>
                            <div className="mt-4 text-left">
                                <label className="block text-sm mb-2 font-bold opacity-70">Variant de Regles:</label>
                                <select value={selectedVariant} onChange={(e) => setSelectedVariant(e.target.value)} className="w-full bg-black/40 border border-white/20 rounded p-2 text-white">
                                    {CRAZY_VARIANTS.map(v => <option key={v.id} value={v.id}>{v.label}</option>)}
                                </select>
                                <p className="text-xs mt-1 text-gray-400">{CRAZY_VARIANTS.find(v=>v.id===selectedVariant)?.desc}</p>
                            </div>
                        </div>
                        <footer className="absolute bottom-4 text-xs text-white/30 w-full text-center">Una adaptació de "Sound Box" de Xavier Ribes - Gemini</footer>
                    </div>
                );
            }

            if (phase === 'setup_names') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-indigo-900 to-black text-center">
                        <div className="absolute top-4 right-4"><button onClick={() => setShowRules(true)} className="p-2 rounded-full bg-white/10 hover:bg-white/20"><Icons.Help /></button></div>
                        {showRules && <RulesModal />}
                        <div className="flex justify-between items-center w-full max-w-md mb-4 px-4">
                            <button onClick={() => setPhase('setup_count')} className="flex items-center gap-1 text-white/70 hover:text-white"><Icons.ArrowLeft size={20} />Tornar</button>
                            <h2 className="text-3xl font-bold">Noms</h2>
                            <div className="w-8"></div>
                        </div>
                        <div className="bg-white/10 p-6 rounded-2xl w-full max-w-md mb-6 border border-white/10 space-y-3">
                            {Array.from({length: playerCount}).map((_, i) => (
                                <div key={i} className="flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold text-sm">{i+1}</span>
                                    <input type="text" placeholder={`Nom jugador ${i+1}`} value={nameInputs[i] || ''} onChange={(e) => setNameInputs({...nameInputs, [i]: e.target.value})} className="flex-1 bg-black/30 border border-white/20 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-400" />
                                </div>
                            ))}
                            {playerCount >= 6 && (
                                <div onClick={() => setHasRecorder(!hasRecorder)} className={`cursor-pointer flex items-center justify-center gap-3 p-3 rounded-lg border transition-all mt-4 ${hasRecorder ? 'bg-purple-500/20 border-purple-500' : 'bg-white/5 border-white/10'}`}>
                                    <div className={`w-6 h-6 rounded flex items-center justify-center border ${hasRecorder ? 'bg-purple-500 border-purple-500' : 'border-gray-400'}`}>{hasRecorder && <Icons.Check size={16} className="text-white" />}</div>
                                    <div className="flex flex-col text-left">
                                        <span className="font-bold text-sm flex items-center gap-2">Jugar amb Enregistrador <Icons.Mic size={14} className="inline text-purple-400"/></span>
                                        <span className="text-xs opacity-70">Un jugador rotatiu ajudarà a recordar els sons (no fa soroll)</span>
                                    </div>
                                </div>
                            )}
                        </div>
                        <button onClick={startGame} className="bg-green-600 px-8 py-3 rounded-xl font-bold text-xl shadow-lg hover:scale-105 transition-transform">Començar Partida</button>
                        <footer className="absolute bottom-4 text-xs text-white/30 w-full text-center">Una adaptació de "Sound Box" de Xavier Ribes - Gemini</footer>
                    </div>
                );
            }

            if (phase === 'assign_double') {
                const listenerName = players[currentListenerIndex];
                const recorderIdx = getRecorderIndex(currentListenerIndex);
                const recorderName = recorderIdx !== -1 ? players[recorderIdx] : null;
                const totalDoubles = getAvailableDoublesCount(score, life);
                const currentTokenNum = currentDoubleAssignStep + 1;
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-indigo-900 text-center">
                        <div className="absolute top-4 right-4"><button onClick={() => setShowRules(true)} className="p-2 rounded-full bg-white/10 hover:bg-white/20"><Icons.Help /></button></div>
                        {showRules && <RulesModal />}
                        <div className="mb-4 text-blue-300"><Icons.Double size={48} className="mx-auto mb-2"/>FITXA DE SO DOBLE {totalDoubles > 1 ? `${currentTokenNum}/${totalDoubles}` : ''} DISPONIBLE!</div>
                        <h2 className="text-2xl font-bold mb-6">Qui farà dos sons (Fitxa {currentTokenNum})?</h2>
                        <p className="mb-2 opacity-70">Escoltador: {listenerName}</p>
                        {recorderName && <p className="mb-6 opacity-70">Enregistrador: {recorderName}</p>}
                        <div className="grid grid-cols-2 gap-4 max-w-md w-full">
                            {players.map((p, i) => {
                                if (i === currentListenerIndex || i === recorderIdx) return null;
                                return <button key={i} onClick={() => handleDoubleAssignment(i)} className="bg-white/10 hover:bg-blue-600 p-4 rounded-xl font-bold transition-colors border border-white/20">{p}</button>;
                            })}
                        </div>
                    </div>
                );
            }

            if (phase === 'gameover') {
                const won = score >= TRACK_LAYOUT.length; 
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-900 text-center">
                        <div className="mb-6 transform scale-150">{won ? <Icons.Crown /> : <Icons.X />}</div>
                        <h1 className="text-5xl font-black mb-4">{won ? "VICTÒRIA!" : "DERROTA..."}</h1>
                        <p className="text-xl mb-8">{won ? "Heu completat el recorregut del Sound Box!" : "El pols ha arribat a zero. Massa confusió acústica!"}</p>
                        <div className="flex gap-4"><div className="bg-white/10 p-4 rounded-lg"><p className="text-3xl font-bold">Puntuació Final: {10 + score}/{10 + TRACK_LAYOUT.length}</p></div></div>
                        <button onClick={() => setPhase('setup_count')} className="mt-12 bg-white text-black px-8 py-3 rounded-full font-bold hover:bg-gray-200">Tornar al Menú</button>
                    </div>
                );
            }

            if (phase === 'roles') {
                const listenerName = players[currentListenerIndex];
                const recorderIdx = getRecorderIndex(currentListenerIndex);
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-indigo-900 text-center">
                        <div className="absolute top-4 right-4"><button onClick={() => setShowRules(true)} className="p-2 rounded-full bg-white/10 hover:bg-white/20"><Icons.Help /></button></div>
                        {showRules && <RulesModal />}
                        <h2 className="text-3xl font-bold mb-8">Nova Ronda</h2>
                        <div className="bg-black/30 p-6 rounded-2xl w-full max-w-md mb-4 border border-white/10">
                            <h3 className="text-xl text-yellow-400 mb-2 font-bold">L'ESCOLTADOR ÉS:</h3>
                            <div className="text-4xl font-black bg-white/10 py-4 rounded-xl px-4 break-words">{listenerName}</div>
                        </div>
                        {recorderIdx !== -1 && <div className="bg-purple-900/30 p-4 rounded-xl w-full max-w-md mb-8 border border-purple-500/30"><h3 className="text-lg text-purple-300 mb-1 font-bold flex justify-center items-center gap-2"><Icons.Mic size={20}/> L'ENREGISTRADOR ÉS:</h3><div className="text-2xl font-bold">{players[recorderIdx]}</div></div>}
                        <div className="text-left bg-red-900/50 p-4 rounded-lg mb-8 max-w-md border border-red-500/30">
                            <ol className="list-decimal list-inside space-y-2 text-sm">
                                <li><strong>{listenerName}</strong> {recorderIdx !== -1 ? `i ${players[recorderIdx]}` : ''} miren les cartes.</li>
                                <li>Després es giren o es tapen els ulls.</li>
                                <li>La resta assigneu els sons.</li>
                            </ol>
                        </div>
                        <button onClick={() => { setPhase('memorize'); }} className="bg-blue-500 px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-400">D'acord</button>
                    </div>
                );
            }

            if (phase === 'memorize') {
                const listenerName = players[currentListenerIndex];
                const recorderIdx = getRecorderIndex(currentListenerIndex);
                const recorderName = recorderIdx !== -1 ? players[recorderIdx] : null;
                return (
                    <div className="min-h-screen p-2 bg-gray-900 flex flex-col">
                        <div className="absolute top-2 right-2"><button onClick={() => setShowRules(true)} className="p-2 rounded-full bg-white/10 hover:bg-white/20"><Icons.Help /></button></div>
                        {showRules && <RulesModal />}
                        <div className="text-center py-2"><h2 className="text-lg font-bold text-blue-300">Memoritza el taulell</h2><p className="text-xs text-gray-400">Escoltador: {listenerName} {recorderName ? `| Enregistrador: ${recorderName}` : ''}</p></div>
                        <div className="flex-1 overflow-auto no-scrollbar">{renderBoard('view')}</div>
                        {renderTrack()}
                        {renderLifeTrack()}
                        <div className="p-4 bg-gray-900/90 backdrop-blur border-t border-white/10 text-center mt-2"><p className="text-yellow-400 font-bold mb-2 animate-pulse text-sm">ARA: {listenerName} {recorderName ? `I ${recorderName.toUpperCase()}` : ''} NO PODEN MIRAR!</p><button onClick={() => { setPhase('reveal_assignments'); }} className="w-full bg-indigo-600 py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-500">Veure assignacions (Resta de jugadors)</button></div>
                    </div>
                );
            }

            if (phase === 'reveal_assignments') {
                 const listenerName = players[currentListenerIndex];
                 const recorderIdx = getRecorderIndex(currentListenerIndex);
                 const recorderName = recorderIdx !== -1 ? players[recorderIdx] : null;
                 return (
                    <div className="min-h-screen flex flex-col bg-gray-800">
                        <div className="bg-red-600 text-white p-2 text-center font-bold animate-pulse text-sm">⛔ {listenerName.toUpperCase()} {recorderName ? `I ${recorderName.toUpperCase()}` : ''}: NO MIREU! ⛔</div>
                        <div className="flex-1 overflow-auto p-2 no-scrollbar flex items-center">{renderBoard('view', true)}</div>
                        <div className="p-4 bg-gray-800/90 backdrop-blur border-t border-white/10"><button onClick={() => { setPhase('perform'); setTimeLeft(13); setTimerActive(false); }} className="w-full bg-red-500 py-4 rounded-xl font-bold text-xl shadow-lg hover:bg-red-400">Amagar i Anar al Timer</button></div>
                    </div>
                );
            }

            if (phase === 'perform') {
                const isUrgent = timerActive && timeLeft <= 3;
                return (
                    <div className={`min-h-screen flex flex-col items-center justify-center p-6 transition-colors duration-500 ${isUrgent ? 'urgent-mode' : (timerActive ? 'bg-red-600' : 'bg-gray-900')}`}>
                        {!timerActive ? (
                            <>
                                <h2 className="text-3xl font-bold mb-8 text-center">Preparats per fer soroll?</h2>
                                {selectedVariant !== 'none' && (
                                    <div className="bg-white/20 p-4 rounded-xl mb-8 animate-bounce border border-white/40">
                                        <div className="font-bold text-yellow-300 uppercase tracking-widest text-xs">Variant Activa</div>
                                        <div className="text-xl font-black">{CRAZY_VARIANTS.find(v=>v.id===selectedVariant)?.label}</div>
                                        <div className="text-sm">{CRAZY_VARIANTS.find(v=>v.id===selectedVariant)?.desc}</div>
                                    </div>
                                )}
                                <button onClick={() => setTimerActive(true)} className="w-64 h-64 rounded-full bg-red-500 border-8 border-red-700 shadow-[0_0_50px_rgba(239,68,68,0.5)] flex items-center justify-center text-5xl font-black hover:scale-105 transition-transform active:scale-95">START</button>
                                <p className="mt-8 opacity-60">L'escoltador {hasRecorder ? "i l'enregistrador" : ''} encara no poden mirar!</p>
                            </>
                        ) : (
                            <>
                                <h2 className="text-2xl font-bold mb-4 animate-bounce">FES EL TEU SOROLL!</h2>
                                <div className="text-[10rem] font-black leading-none tabular-nums">{timeLeft}</div>
                                <div className="mt-8 w-full max-w-xs h-4 bg-black/30 rounded-full overflow-hidden"><div className={`h-full transition-all duration-1000 ease-linear ${isUrgent ? 'progress-bar-fill' : 'bg-white'}`} style={{ width: `${(timeLeft/13)*100}%` }}></div></div>
                            </>
                        )}
                    </div>
                );
            }

            if (phase === 'guess') {
                const recorderIdx = getRecorderIndex(currentListenerIndex);
                return (
                    <div className="min-h-screen bg-gray-900 flex flex-col">
                        <div className="flex justify-between items-center p-2 bg-black/40 backdrop-blur-sm sticky top-0 z-20 border-b border-white/10">
                            <div className="flex items-center gap-2"><Icons.Crown size={20} className="text-yellow-400"/><span className="font-bold">{score >= TRACK_LAYOUT.length ? 'Final' : 10 + score}</span></div>
                            <div className="text-center text-sm font-bold text-blue-300">{players[currentListenerIndex]} endevina</div>
                            <div className="flex items-center gap-2"><Icons.Heart size={20} className="text-red-500"/><span className="font-bold">{life}</span></div>
                        </div>
                        {recorderIdx !== -1 && <div className="bg-purple-900/50 p-2 text-center text-xs text-purple-200"><Icons.Mic size={12} className="inline mr-1"/><strong>{players[recorderIdx]}</strong> pot ajudar a recordar els sons!</div>}
                        <div className="flex-1 overflow-auto p-2 no-scrollbar">{renderBoard('guess')}</div>
                        {renderTrack()}
                        {renderLifeTrack()}
                        <div className="p-4 bg-gradient-to-t from-black to-transparent flex justify-center"><button onClick={() => endRound(false, revealedCards.length)} className="bg-red-900/80 text-red-200 px-6 py-2 rounded-full text-sm font-bold backdrop-blur border border-red-500/30 hover:bg-red-900">Finalitzar Ronda</button></div>
                    </div>
                );
            }

            if (phase === 'results') {
                const roundHits = revealedCards.length;
                let totalAssignedCards = 0;
                let totalPenalty = 0;
                Object.values(assignments).forEach(arr => {
                    totalAssignedCards += arr.length;
                    arr.forEach(cardIdx => { if (!revealedCards.includes(cardIdx)) totalPenalty += getPenalty(cardIdx); });
                });
                
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-900 text-center">
                        <h2 className="text-3xl font-bold mb-6">Resultats Ronda</h2>
                        <div className="bg-white/5 p-6 rounded-2xl w-full max-w-sm mb-6 border border-white/10">
                            <div className="flex justify-between mb-4 border-b border-white/10 pb-4">
                                <div className="text-green-400"><div className="text-4xl font-bold">+{roundHits}</div><div className="text-xs uppercase">Encerts</div></div>
                                <div className="text-red-400"><div className="text-4xl font-bold">-{totalPenalty}</div><div className="text-xs uppercase">Pols perdut</div></div>
                            </div>
                            <div className="flex justify-between items-center text-sm">
                                <div className="flex items-center gap-2"><span className="text-gray-400">Total Progrés:</span><span className="text-xl font-bold text-yellow-400">{score >= TRACK_LAYOUT.length ? 'Final' : 10 + score}/{10 + TRACK_LAYOUT.length}</span></div>
                                <div className="flex items-center gap-2"><span className="text-gray-400">Vida:</span><span className="text-xl font-bold text-red-500">{life}</span></div>
                            </div>
                        </div>
                        <div className="space-y-2 w-full max-w-sm text-left mb-8 max-h-60 overflow-auto no-scrollbar">
                            <p className="text-xs text-gray-500 uppercase tracking-widest mb-2">Assignacions:</p>
                            {Object.entries(assignments).map(([pid, cardIndices]) => {
                                return cardIndices.map(cid => {
                                    const isGuessed = revealedCards.includes(cid);
                                    const penalty = getPenalty(cid);
                                    return (
                                        <div key={`${pid}-${cid}`} className={`flex justify-between p-2 rounded bg-white/5 text-xs ${isGuessed ? 'border-l-2 border-green-500' : 'border-l-2 border-red-500'}`}>
                                            <span>{players[pid]}</span>
                                            <div className="flex items-center gap-2"><span className="font-bold">{roundCards[cid].text}</span>{!isGuessed && (<span className="text-red-400 font-bold flex items-center gap-0.5">-{penalty} <Icons.Heart size={10} className="fill-current inline"/></span>)}</div>
                                        </div>
                                    );
                                });
                            })}
                        </div>
                        <button onClick={nextRound} className="bg-blue-600 w-full max-w-xs py-4 rounded-xl font-bold text-xl hover:bg-blue-500 shadow-lg">Següent Ronda</button>
                    </div>
                );
            }

            return <div>Carregant...</div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
